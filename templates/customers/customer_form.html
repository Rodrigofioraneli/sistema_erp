{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h4 class="mb-0 text-primary">
                        {% if form.instance.pk %}‚úèÔ∏è Editar Cliente{% else %}üë§ Novo Cliente{% endif %}
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Renderiza os campos do formul√°rio organizados -->
                        <div class="row g-3">
                            {% for field in form %}
                            <div class="col-md-6">
                                <label for="{{ field.id_for_label }}" class="form-label fw-bold small text-muted">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                <div class="text-danger small">{{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{% url 'customer_list' %}" class="btn btn-outline-secondary">Cancelar</a>
                            {% if not readonly %}
                            <button type="submit" class="btn btn-success px-4">Salvar Cliente</button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // --- Busca de CEP (ViaCEP) ---
        const cepInput = document.getElementById('id_zip_code');
        
        if (cepInput) {
            cepInput.addEventListener('blur', function() {
                let cep = this.value.replace(/\D/g, '');
                
                if (cep.length === 8) {
                    // Feedback visual
                    document.getElementById('id_street').value = "...";
                    document.getElementById('id_neighborhood').value = "...";
                    document.getElementById('id_city').value = "...";
                    document.getElementById('id_state').value = "...";

                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data.erro) {
                                if(document.getElementById('id_street')) document.getElementById('id_street').value = data.logradouro;
                                if(document.getElementById('id_neighborhood')) document.getElementById('id_neighborhood').value = data.bairro;
                                if(document.getElementById('id_city')) document.getElementById('id_city').value = data.localidade;
                                if(document.getElementById('id_state')) document.getElementById('id_state').value = data.uf;
                                if(document.getElementById('id_number')) document.getElementById('id_number').focus();
                            } else {
                                alert("CEP n√£o encontrado.");
                                cleanAddressFields();
                            }
                        })
                        .catch(() => {
                            alert("Erro ao buscar CEP.");
                            cleanAddressFields();
                        });
                }
            });
        }

        function cleanAddressFields() {
            if(document.getElementById('id_street')) document.getElementById('id_street').value = "";
            if(document.getElementById('id_neighborhood')) document.getElementById('id_neighborhood').value = "";
            if(document.getElementById('id_city')) document.getElementById('id_city').value = "";
            if(document.getElementById('id_state')) document.getElementById('id_state').value = "";
        }

        // --- Busca de CNPJ (BrasilAPI) ---
        // Nota: Busca de nome por CPF n√£o √© permitida em APIs p√∫blicas gratuitas por privacidade.
        const docInput = document.getElementById('id_cpf_cnpj');
        const nameInput = document.getElementById('id_name');

        if (docInput) {
            docInput.addEventListener('blur', function() {
                let doc = this.value.replace(/\D/g, '');

                // Se for CNPJ (14 d√≠gitos), busca na BrasilAPI
                if (doc.length === 14) {
                    nameInput.placeholder = "Buscando dados da empresa...";
                    fetch(`https://brasilapi.com.br/api/cnpj/v1/${doc}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.razao_social) {
                                nameInput.value = data.nome_fantasia || data.razao_social;
                                // Tenta preencher endere√ßo tamb√©m se a API retornar
                                if (data.cep && cepInput) {
                                    cepInput.value = data.cep;
                                    // Dispara o evento de blur do CEP para preencher o resto
                                    cepInput.dispatchEvent(new Event('blur'));
                                }
                                // Preenche outros dados se dispon√≠veis
                                const phoneInput = document.getElementById('id_phone');
                                if (data.ddd_telefone_1 && phoneInput) {
                                    phoneInput.value = `(${data.ddd_telefone_1.substring(0,2)}) ${data.ddd_telefone_1.substring(2)}`;
                                }
                            }
                        })
                        .catch(err => console.log("CNPJ n√£o encontrado ou erro na API"));
                }
            });
        }
    });
</script>
{% endblock %}